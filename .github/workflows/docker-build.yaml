name: ğŸ³ Docker Build Pipeline

on:
  workflow_call:

jobs:
  docker-build:
    name: ğŸ³ Docker Build & Validation
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker
        uses: docker/setup-buildx-action@v2

      - name: âœ”ï¸ Validate Dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "âœ… Dockerfile found"
            docker build --dry-run . || echo "âš ï¸ Dockerfile syntax check (non-blocking)"
          else
            echo "âš ï¸ No Dockerfile found in root"
          fi

      - name: âœ”ï¸ Validate Docker Compose
        run: |
          if [ -f docker-compose.yml ]; then
            echo "âœ… docker-compose.yml found"
            docker-compose config > /dev/null && echo "âœ… docker-compose syntax valid" || echo "âŒ docker-compose syntax invalid"
          else
            echo "âš ï¸ No docker-compose.yml found"
          fi

      - name: ğŸ—ï¸ Build Docker Image (Dry Run)
        run: |
          if [ -f Dockerfile ]; then
            docker build -t soft-architect-ai:test . --progress=plain || echo "âš ï¸ Build failed (non-blocking)"
          fi

      - name: ğŸ”’ Security Scan (Trivy)
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy Results
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ“ Check Image Size
        if: always()
        run: |
          if [ -f Dockerfile ]; then
            echo "ğŸ³ Docker image size check:"
            docker images | grep soft-architect-ai || echo "Image not built"
          fi

      - name: ğŸ” Infrastructure Validation
        run: |
          if [ -f infrastructure/docker-compose.yml ]; then
            echo "âœ… infrastructure/docker-compose.yml found"
            docker-compose -f infrastructure/docker-compose.yml config > /dev/null && echo "âœ… Infrastructure config valid" || echo "âŒ Infrastructure config invalid"
          fi
