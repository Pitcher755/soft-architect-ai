
name: ðŸ Backend CI Pipeline

on:
  workflow_call:

jobs:
  backend-tests:
    name: ðŸ”¬ Backend Quality & Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

name: ðŸ Backend CI (Python/FastAPI)

# DISPARADOR: Solo cuando hay cambios en Python/Backend
on:
  push:
    branches: [main, develop, feature/backend-skeleton]
    paths:
      - 'api/**'
      - 'core/**'
      - 'domain/**'
      - 'services/**'
      - 'utils/**'
      - 'main.py'
      - 'requirements.txt'
      - 'pyrightconfig.json'
      - '.github/workflows/backend-ci.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'api/**'
      - 'core/**'
      - 'domain/**'
      - 'services/**'
      - 'utils/**'
      - 'main.py'
      - 'requirements.txt'

  # âœ¨ NUEVO: Permitir que sea reutilizable por otros workflows
  workflow_call:

# Permite solo una ejecuciÃ³n por rama a la vez
concurrency:
  group: backend-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: LINTING Y ANÃLISIS ESTÃTICO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  code-quality:
    name: ðŸ” Code Quality (Ruff + Black + MyPy)
    runs-on: ubuntu-latest


    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4


      - name: ðŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

        with:
          fetch-depth: 0  # Full history para anÃ¡lisis

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Cache pip dependencies


      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt


      - name: ðŸŽ¨ Code Formatting (Black)
        run: |
          python -m black --check . --exclude=__pycache__,venv,.venv,build,dist || true

      - name: ðŸ” Linting (Ruff)
        run: |
          python -m ruff check . || true

      - name: ðŸ”’ Security Scan (Bandit)
        run: |
          python -m bandit -r api/ core/ domain/ services/ utils/ --exit-code 0 || true

      - name: ðŸ§ª Unit Tests (Pytest)
        run: |
          python -m pytest tests/ -v --tb=short --cov=api,core,domain,services,utils --cov-report=term-missing

      - name: ðŸš€ Startup Verification
        run: |
          python -c "from core.config import settings; print(f'âœ… API Config loaded: {settings.app_name}')"

      - name: ðŸ“Š Coverage Report
        if: always()
        run: |
          python -m pytest tests/ --cov=api,core,domain,services,utils --cov-report=xml --cov-report=html || true

      - name: ðŸ“ˆ Upload Coverage
        if: always()
        uses: codecov/codecov-action@v3

          pip install ruff black mypy pytest-cov

      - name: ðŸŽ¨ Check Code Formatting (Black)
        run: |
          echo "Checking code formatting with Black..."
          black --check --diff . || echo "Format issues found"
        continue-on-error: true

      - name: âš¡ Lint with Ruff
        run: |
          echo "Running Ruff linter..."
          ruff check . --diff

      - name: ðŸ” Type Check with MyPy
        run: |
          echo "Running MyPy type checker..."
          mypy . --ignore-missing-imports --no-error-summary
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: PRUEBAS UNITARIAS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  unit-tests:
    name: ðŸ§ª Unit Tests (pytest)
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: ðŸƒ Run Unit Tests
        run: |
          echo "Running pytest tests..."
          pytest tests/ -v --cov=api --cov=core --cov=services --cov-report=xml --cov-report=html
        continue-on-error: false

      - name: ðŸ“Š Upload Coverage Report
        uses: codecov/codecov-action@v3
        if: always()

        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage


          fail_ci_if_error: false

      - name: ðŸ“ˆ Generate Coverage Badge
        run: |
          echo "Coverage report generated in htmlcov/index.html"
          ls -la htmlcov/ | head -20

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: SEGURIDAD - VALIDACIÃ“N DE DEPENDENCIAS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-check:
    name: ðŸ”’ Security Scan (Bandit + Safety)
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      - name: ðŸ” Bandit Security Check
        run: |
          echo "Scanning for security issues with Bandit..."
          bandit -r api/ core/ services/ utils/ main.py -f json -o bandit-report.json || true
          echo "Bandit scan complete (warnings are non-blocking)"

      - name: âš ï¸ Safety Dependency Check
        run: |
          echo "Checking for vulnerable dependencies..."
          safety check --json || echo "Some vulnerabilities found (for review)"
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: VERIFICAR QUE LA APP INICIA CORRECTAMENTE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  startup-test:
    name: âœ¨ Startup Verification
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸš€ Test FastAPI Startup
        run: |
          echo "Testing FastAPI app import and validation..."
          python -c "from main import app; print('âœ… FastAPI app loaded successfully')"

      - name: ðŸ“ Generate OpenAPI Schema
        run: |
          echo "Verifying OpenAPI schema generation..."
          python -c "from main import app; import json; schema = app.openapi(); print(f'âœ… OpenAPI schema valid ({len(schema)} keys)')"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NOTIFICACIONES Y REPORTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  job-summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, security-check, startup-test]
    if: always()

    steps:
      - name: âœ… Backend CI Complete
        run: |
          echo "## âœ… Backend CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Code formatting (Black)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Linting (Ruff)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Type checking (MyPy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Unit tests (pytest)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Security scan (Bandit + Safety)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Startup verification" >> $GITHUB_STEP_SUMMARY

