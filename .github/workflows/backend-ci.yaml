name: ğŸ Backend CI Pipeline

on:
  workflow_call:

jobs:
  backend-tests:
    name: ğŸ”¬ Backend Quality & Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ¨ Code Formatting (Black)
        run: |
          python -m black --check . --exclude=__pycache__,venv,.venv,build,dist || true

      - name: ğŸ” Linting (Ruff)
        run: |
          python -m ruff check . || true

      - name: ğŸ”’ Security Scan (Bandit)
        run: |
          python -m bandit -r api/ core/ domain/ services/ utils/ --exit-code 0 || true

      - name: ğŸ§ª Unit Tests (Pytest)
        run: |
          python -m pytest tests/ -v --tb=short --cov=api,core,domain,services,utils --cov-report=term-missing

      - name: ğŸš€ Startup Verification
        run: |
          python -c "from core.config import settings; print(f'âœ… API Config loaded: {settings.app_name}')"

      - name: ğŸ“Š Coverage Report
        if: always()
        run: |
          python -m pytest tests/ --cov=api,core,domain,services,utils --cov-report=xml --cov-report=html || true

      - name: ğŸ“ˆ Upload Coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage
