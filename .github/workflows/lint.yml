name: Code Quality & English Compliance

# Run on every push to main/develop and all PRs
on:
  push:
    branches: [main, develop, feature/backend-skeleton]
    paths:
      - 'src/**'
      - '.github/workflows/lint.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'

# Environment variables
env:
  PYTHON_VERSION: '3.12'
  FLUTTER_VERSION: 'latest'

jobs:
  dart-lint:
    name: Flutter/Dart Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if Flutter client exists
        id: check_flutter
        run: |
          if [ -d "src/client" ]; then
            echo "flutter_exists=true" >> $GITHUB_OUTPUT
          else
            echo "flutter_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Flutter
        if: steps.check_flutter.outputs.flutter_exists == 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          cache: true

      - name: Get Flutter dependencies
        if: steps.check_flutter.outputs.flutter_exists == 'true'
        run: cd src/client && flutter pub get

      - name: Run Flutter analyzer
        if: steps.check_flutter.outputs.flutter_exists == 'true'
        run: cd src/client && flutter analyze

      - name: Check Dart formatting
        if: steps.check_flutter.outputs.flutter_exists == 'true'
        run: cd src/client && dart format --set-exit-if-changed lib/

      - name: Run Flutter tests (if exist)
        if: steps.check_flutter.outputs.flutter_exists == 'true'
        run: cd src/client && flutter test 2>/dev/null || true
        continue-on-error: true

      - name: Skip Flutter (client not yet initialized)
        if: steps.check_flutter.outputs.flutter_exists == 'false'
        run: echo "â­ï¸  Flutter client not yet initialized. Skipping Dart linting."

  python-lint:
    name: Python Linting & Type Checking
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Poetry
        run: pip install poetry==1.8.3

      - name: Install project dependencies
        run: cd src/server && poetry install

      - name: Run Ruff linting
        run: cd src/server && poetry run ruff check app/ || true
        continue-on-error: true

      - name: Run Ruff formatting check
        run: cd src/server && poetry run ruff format --check app/ || true
        continue-on-error: true

      - name: Run pytest
        run: cd src/server && poetry run pytest tests/ -v --tb=short || true
        continue-on-error: true

      - name: Run Bandit security check
        run: cd src/server && poetry run bandit -r app/ -f json --severity-level medium || true
        continue-on-error: true

  english-compliance:
    name: English Compliance Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check for Spanish in Dart files
        run: |
          echo "ğŸ” Checking Dart files for Spanish..."
          if find src/client/lib -name "*.dart" -exec grep -l "// .*[Ã¡Ã©Ã­Ã³ÃºÃ±Â¡Â¿]" {} \; 2>/dev/null | head -5; then
            echo "âš ï¸  Found potential Spanish comments in Dart"
          else
            echo "âœ… No Spanish comments found in Dart"
          fi
        continue-on-error: true

      - name: Check for Spanish in Python files
        run: |
          echo "ğŸ” Checking Python files for Spanish..."
          if find src/server/app -name "*.py" -exec grep -l "# .*[Ã¡Ã©Ã­Ã³ÃºÃ±Â¡Â¿]" {} \; 2>/dev/null | head -5; then
            echo "âš ï¸  Found potential Spanish comments in Python"
          else
            echo "âœ… No Spanish comments found in Python"
          fi
        continue-on-error: true

      - name: Make audit script executable
        run: chmod +x scripts/audit-english-compliance.sh || true

      - name: Run English compliance audit
        run: ./scripts/audit-english-compliance.sh || true
        continue-on-error: true

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [dart-lint, python-lint, english-compliance]
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… Code Quality & Compliance Check Done  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Dart/Flutter linting completed (skipped if client not initialized)"
          echo "âœ… Python linting & security checks completed"
          echo "âœ… English compliance audit completed"
          echo ""
          echo "Reference: AGENTS.md Â§6 - Code Language Standards"
          echo "Backend Tests: See TEST_STRATEGY_AND_ROADMAP.md for coverage details"
