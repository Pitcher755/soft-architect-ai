
name: ðŸ“± Frontend CI Pipeline

on:
  workflow_call:

jobs:
  frontend-tests:
    name: ðŸŽ¨ Frontend Quality & Tests
    runs-on: ubuntu-latest

name: ðŸ“± Frontend CI (Flutter/Dart)

# DISPARADOR: Solo cuando hay cambios en Flutter/Frontend
on:
  push:
    branches: [main, develop, feature/backend-skeleton]
    paths:
      - 'src/client/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.github/workflows/frontend-ci.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/client/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'

  # âœ¨ NUEVO: Permitir que sea reutilizable por otros workflows
  workflow_call:

# Permite solo una ejecuciÃ³n por rama a la vez
concurrency:
  group: frontend-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.19.0'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CHECK: Â¿Existe cliente Flutter?
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  check-flutter:
    name: ðŸ” Check Flutter Project
    runs-on: ubuntu-latest
    outputs:
      flutter_exists: ${{ steps.check.outputs.flutter_exists }}

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“ Verify Flutter Structure
        id: check
        run: |
          if [ -d "src/client" ] && [ -f "pubspec.yaml" ]; then
            echo "flutter_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Flutter project detected"
            ls -la src/client/ | head -10
          else
            echo "flutter_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Flutter project not found (this is OK for backend-first development)"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: ANÃLISIS ESTÃTICO Y LINTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dart-analysis:
    name: ðŸ” Dart Analysis & Linting
    runs-on: ubuntu-latest
    needs: check-flutter
    if: needs.check-flutter.outputs.flutter_exists == 'true'


    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:

          flutter-version: 'latest'
          channel: 'stable'

      - name: ðŸ“¦ Get Flutter Dependencies
        run: |
          cd src/client
          flutter pub get
          flutter doctor -v

      - name: ðŸ” Flutter Analyze
        run: |
          cd src/client
          flutter analyze

      - name: ðŸ§ª Flutter Tests
        run: |
          cd src/client
          flutter test --coverage || true

      - name: ðŸ—ï¸ Build Desktop (Linux)
        if: runner.os == 'Linux'
        run: |
          cd src/client
          flutter build linux --release || flutter build linux || true

      - name: ðŸ“Š Dependency Health Check
        run: |
          cd src/client
          flutter pub outdated --exit-code 0 || true

      - name: âœ¨ Format Check (Dart)
        run: |
          cd src/client
          dart format --set-exit-if-changed . || true

          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          cache-key: flutter-${{ hashFiles('pubspec.lock') }}

      - name: ðŸ“¦ Get Flutter Dependencies
        run: cd src/client && flutter pub get

      - name: ðŸ” Run Flutter Analyzer
        run: |
          cd src/client
          echo "Running Dart analyzer..."
          flutter analyze --no-fatal-infos

      - name: ðŸŽ¨ Check Code Formatting
        run: |
          cd src/client
          echo "Checking Dart formatting..."
          dart format --output=none --set-exit-if-changed . || echo "Format issues detected"
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: PRUEBAS UNITARIAS DE WIDGETS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  widget-tests:
    name: ðŸ§ª Widget Tests
    runs-on: ubuntu-latest
    needs: [check-flutter, dart-analysis]
    if: needs.check-flutter.outputs.flutter_exists == 'true'

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: cd src/client && flutter pub get

      - name: ðŸƒ Run Widget Tests
        run: |
          cd src/client
          echo "Running widget tests..."
          flutter test --coverage

      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./src/client/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: VERIFICACIÃ“N DE COMPILACIÃ“N DESKTOP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  desktop-build:
    name: ðŸ–¥ï¸ Desktop Build Test
    runs-on: ubuntu-latest
    needs: [check-flutter, dart-analysis]
    if: needs.check-flutter.outputs.flutter_exists == 'true'

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: cd src/client && flutter pub get

      - name: ðŸ–¥ï¸ Enable Linux Desktop
        run: cd src/client && flutter config --enable-linux-desktop

      - name: ðŸ”§ Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libx11-dev pkg-config cmake ninja-build libblkid-dev

      - name: ðŸ—ï¸ Build Linux Desktop
        run: |
          cd src/client
          echo "Building Flutter desktop app..."
          flutter build linux --debug --verbose 2>&1 | tail -50
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: VERIFICACIÃ“N DE DEPENDENCIAS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dependency-check:
    name: ðŸ“¦ Dependency Health Check
    runs-on: ubuntu-latest
    needs: check-flutter
    if: needs.check-flutter.outputs.flutter_exists == 'true'

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: cd src/client && flutter pub get

      - name: ðŸ” Pub Outdated Check
        run: |
          cd src/client
          echo "Checking for outdated dependencies..."
          flutter pub outdated --no-dependency-names || true

      - name: ðŸ” Pub Audit (Security)
        run: |
          cd src/client
          echo "Running pub security audit..."
          flutter pub publish --dry-run 2>&1 | grep -i "error\|warning" || echo "No issues found"
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFICACIONES Y REPORTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  job-summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [check-flutter, dart-analysis, widget-tests, desktop-build, dependency-check]
    if: always()

    steps:
      - name: âœ… Frontend CI Complete
        run: |
          if [ "${{ needs.check-flutter.outputs.flutter_exists }}" == "true" ]; then
            echo "## âœ… Frontend CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Flutter analyzer" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Code formatting (Dart format)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Widget tests" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Desktop build (Linux)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Dependency health" >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ Frontend CI Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Flutter project not detected (OK for backend-focused development)" >> $GITHUB_STEP_SUMMARY
          fi

