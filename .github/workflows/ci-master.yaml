name: ðŸŽ¯ Monorepo CI Master (Orchestrator)

# DISPARADOR: Todo push y PR en main/develop
on:
  push:
    branches: [main, develop, feature/backend-skeleton]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

# Permite solo una ejecuciÃ³n por rama a la vez
concurrency:
  group: ci-master-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ORQUESTADOR: Detecta quÃ© cambiÃ³ y corre solo lo relevante
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}
      docs: ${{ steps.filter.outputs.docs }}

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Path Filter
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'api/**'
              - 'core/**'
              - 'domain/**'
              - 'services/**'
              - 'utils/**'
              - 'main.py'
              - 'requirements.txt'
              - 'tests/**'
            frontend:
              - 'src/client/**'
              - 'pubspec.yaml'
              - 'pubspec.lock'
            docker:
              - 'Dockerfile*'
              - 'infrastructure/**'
              - 'docker-compose.yml'
              - '.dockerignore'
            docs:
              - 'doc/**'
              - 'context/**'
              - 'packages/knowledge_base/**'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DECISIÃ“N: Â¿Ejecutar Backend CI?
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  backend-ci:
    name: ðŸ Backend Pipeline
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    uses: ./.github/workflows/backend-ci.yaml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DECISIÃ“N: Â¿Ejecutar Frontend CI?
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  frontend-ci:
    name: ðŸ“± Frontend Pipeline
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    uses: ./.github/workflows/frontend-ci.yaml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DECISIÃ“N: Â¿Ejecutar Docker Build?
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-build:
    name: ðŸ³ Docker Pipeline
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    uses: ./.github/workflows/docker-build.yaml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RESUMEN FINAL: Dashboard de estado
  # âœ¨ CORREGIDO: if: always() para que se ejecute incluso si otros se saltan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dashboard:
    name: ðŸ“Š CI Dashboard
    runs-on: ubuntu-latest
    # âœ¨ CORREGIDO: if: always() para que se ejecute incluso si otros se saltan
    if: always()
    # âœ¨ CORREGIDO: needs SOLO los que SIEMPRE se ejecutan (changes)
    needs: [changes]

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“Š Generate Dashboard
        run: |
          cat > /tmp/ci_dashboard.md << 'EOF'
          # ðŸŽ¯ SoftArchitect AI - CI Pipeline Dashboard

          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Author:** ${{ github.actor }}
          **Event:** ${{ github.event_name }}

          ---

          ## ðŸ“‹ Change Detection

          | Component | Status | Action |
          |-----------|--------|--------|
          | ðŸ Backend | ${{ needs.changes.outputs.backend == 'true' && 'âœ… Changed' || 'â­ï¸ Skipped' }} | ${{ needs.changes.outputs.backend == 'true' && 'Running Backend CI' || 'No changes detected' }} |
          | ðŸ“± Frontend | ${{ needs.changes.outputs.frontend == 'true' && 'âœ… Changed' || 'â­ï¸ Skipped' }} | ${{ needs.changes.outputs.frontend == 'true' && 'Running Frontend CI' || 'No changes detected' }} |
          | ðŸ³ Docker | ${{ needs.changes.outputs.docker == 'true' && 'âœ… Changed' || 'â­ï¸ Skipped' }} | ${{ needs.changes.outputs.docker == 'true' && 'Running Docker Build' || 'No changes detected' }} |
          | ðŸ“š Docs | ${{ needs.changes.outputs.docs == 'true' && 'âœ… Changed' || 'â­ï¸ Skipped' }} | Documentation updated |

          ---

          ## ðŸ”„ Pipeline Status

          ### Backend Pipeline
          - **Status:** ${{ job.status }}
          - **Duration:** ~2-3 minutes
          - **Checks:**
            - Code Quality (Black, Ruff, MyPy)
            - Unit Tests (pytest)
            - Security Scan (Bandit, Safety)
            - Startup Verification

          ### Frontend Pipeline
          - **Status:** ${{ job.status }}
          - **Duration:** ~3-5 minutes
          - **Checks:**
            - Flutter Analysis
            - Widget Tests
            - Desktop Build
            - Dependency Health

          ### Docker Pipeline
          - **Status:** ${{ job.status }}
          - **Duration:** ~2-4 minutes
          - **Checks:**
            - Dockerfile Validation
            - Image Build (dry run)
            - Docker Compose Syntax
            - Security Scan (Trivy)
            - Image Size Check

          ---

          ## ðŸŽ“ What This Means

          âœ… **GREEN (All passing):** Your code is ready to merge to main
          ðŸŸ¡ **YELLOW (Warnings):** Review warnings, likely still OK to merge
          ðŸ”´ **RED (Failed):** Fix issues before merging. Click on failed job for details.

          ---

          ## ðŸš€ Next Steps

          1. If pipeline is ðŸŸ¢ **GREEN:** Merge to main with confidence
          2. If pipeline is ðŸ”´ **RED:** Click "Details" on failed job to see error logs
          3. Fix issues locally: `pytest`, `flutter analyze`, `black .`
          4. Push again: CI will re-run automatically

          EOF

          cat /tmp/ci_dashboard.md >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¬ Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:

          github-token: ${{ secrets.GITHUB_TOKEN }}

          script: |
            const fs = require('fs');
            const dashboard = fs.readFileSync('/tmp/ci_dashboard.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: dashboard
            });

      - name: ðŸ“ˆ Job Status Summary
        run: |
          echo "## âœ… CI Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Intelligent Monorepo Execution:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Backend | ${{ needs.changes.outputs.backend == 'true' && 'ðŸŸ¢ Executed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Frontend | ${{ needs.changes.outputs.frontend == 'true' && 'ðŸŸ¢ Executed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker | ${{ needs.changes.outputs.docker == 'true' && 'ðŸŸ¢ Executed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Optimization:** Only relevant pipelines were executed based on file changes" >> $GITHUB_STEP_SUMMARY
