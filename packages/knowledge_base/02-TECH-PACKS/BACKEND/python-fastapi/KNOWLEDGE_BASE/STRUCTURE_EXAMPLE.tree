# Directory Structure: SoftArchitect Python FastAPI Backend

## Clean Architecture + ASGI Best Practices

```
src/
â”œâ”€â”€ ğŸ“„ main.py                       # â­ Entry Point (App initialization & config)
â”‚
â”œâ”€â”€ ğŸ“ core/                         # âš™ï¸ Global Configuration & Utilities
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                    # Pydantic Settings (Env vars, DB URL, Secrets)
â”‚   â”œâ”€â”€ exceptions.py                # Custom Domain Exceptions (DomainError, ValidationError)
â”‚   â”œâ”€â”€ logger.py                    # Structured logging setup
â”‚   â””â”€â”€ security.py                  # Auth logic (JWT tokens, password hashing)
â”‚
â”œâ”€â”€ ğŸ“ api/                          # ğŸ¨ Presentation Layer (HTTP/REST Interface)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dependencies.py              # Reusable endpoint dependencies (CurrentUser, AuthService)
â”‚   â””â”€â”€ ğŸ“ v1/                       # API versioning
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ router.py                # Main router aggregator (combines all endpoints)
â”‚       â””â”€â”€ ğŸ“ endpoints/            # Endpoint definitions per domain
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ auth.py              # POST /auth/login, /auth/register
â”‚           â”œâ”€â”€ users.py             # GET/POST /users, /users/{id}
â”‚           â”œâ”€â”€ documents.py         # GET /documents (for RAG)
â”‚           â””â”€â”€ {{DOMAIN}}.py        # Feature-specific endpoints
â”‚
â”œâ”€â”€ ğŸ“ domain/                       # ğŸ§  Business Logic (Completely Framework-Agnostic)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ğŸ“ models/                   # Database Models (SQLAlchemy/SQLModel)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py                  # class User(Base): id, email, password_hash, created_at
â”‚   â”‚   â”œâ”€â”€ document.py              # class Document(Base): id, title, content, embedding
â”‚   â”‚   â””â”€â”€ {{ENTITY}}.py
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ schemas/                  # Pydantic Models (Request/Response DTOs)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py                  # UserCreateRequest, UserResponse, UserUpdateRequest
â”‚   â”‚   â”œâ”€â”€ document.py              # DocumentCreateRequest, DocumentResponse
â”‚   â”‚   â””â”€â”€ {{SCHEMA}}.py
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ services/                 # Use Cases / Business Logic (Pure functions)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py          # create_user(), get_user(), authenticate()
â”‚   â”‚   â”œâ”€â”€ auth_service.py          # verify_jwt(), generate_token()
â”‚   â”‚   â”œâ”€â”€ document_service.py      # index_document(), search_documents()
â”‚   â”‚   â””â”€â”€ {{SERVICE}}.py
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ exceptions/               # Domain-specific exceptions
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ user_exceptions.py       # UserNotFoundError, InvalidCredentialsError
â”‚       â”œâ”€â”€ document_exceptions.py   # DocumentNotFoundError
â”‚       â””â”€â”€ {{DOMAIN}}_exceptions.py
â”‚
â”œâ”€â”€ ğŸ“ infrastructure/               # ğŸ”Œ Technical Implementation (Adapters & External Systems)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ database.py                  # SQLAlchemy Engine, SessionLocal, Base class
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ repositories/             # Data Access Layer (DAL) - implements Repository pattern
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base_repository.py       # Generic CRUD operations
â”‚   â”‚   â”œâ”€â”€ user_repository.py       # class UserRepository(BaseRepository): get_by_email(), etc
â”‚   â”‚   â”œâ”€â”€ document_repository.py   # class DocumentRepository: search(), index()
â”‚   â”‚   â””â”€â”€ {{ENTITY}}_repository.py
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ external/                 # External API Integrations
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ ollama_client.py         # Communicate with Ollama local LLM
â”‚   â”‚   â”œâ”€â”€ chroma_client.py         # Vector DB integration
â”‚   â”‚   â””â”€â”€ {{SERVICE}}_client.py
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ cache/                    # Caching layer (Redis, in-memory)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ cache_provider.py        # Abstract cache interface + implementations
â”‚
â”œâ”€â”€ ğŸ“ tests/                        # ğŸ§ª Test Suite (Mirrors src structure)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py                  # Pytest fixtures (db_session, app_client, test_user)
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ unit/                     # Unit Tests (~70% coverage)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ test_user_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_auth_service.py
â”‚   â”‚   â”‚   â””â”€â”€ test_{{SERVICE}}.py
â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â”œâ”€â”€ test_user_repository.py
â”‚   â”‚   â”‚   â””â”€â”€ test_{{REPOSITORY}}.py
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â””â”€â”€ test_endpoint_handlers.py
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ integration/              # Integration Tests (~20% coverage)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_user_flow.py        # Create user â†’ login â†’ get profile
â”‚   â”‚   â”œâ”€â”€ test_document_flow.py    # Upload document â†’ index â†’ search
â”‚   â”‚   â””â”€â”€ test_{{FLOW}}.py
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ e2e/                      # End-to-End Tests (~10% coverage, slow)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ test_full_rag_flow.py    # Index doc â†’ Query â†’ Get response
â”‚
â”œâ”€â”€ ğŸ“ migrations/                   # Alembic database migrations
â”‚   â”œâ”€â”€ versions/
â”‚   â”‚   â”œâ”€â”€ 001_initial_schema.py
â”‚   â”‚   â””â”€â”€ {{VERSION}}_{{MIGRATION}}.py
â”‚   â”œâ”€â”€ env.py
â”‚   â””â”€â”€ script.py.mako
â”‚
â”œâ”€â”€ ğŸ“ scripts/                      # Utility scripts
â”‚   â”œâ”€â”€ seed_db.py                   # Populate database with test data
â”‚   â”œâ”€â”€ migrate.py                   # Run Alembic migrations
â”‚   â””â”€â”€ {{UTILITY}}.py
â”‚
â”œâ”€â”€ ğŸ“„ pyproject.toml                # Project metadata & dependencies (Poetry)
â”œâ”€â”€ ğŸ“„ poetry.lock                   # Locked versions (COMMIT THIS!)
â”œâ”€â”€ ğŸ“„ pyrightconfig.json            # Type checker config (strict mode)
â”œâ”€â”€ ğŸ“„ .env.example                  # Environment variables template
â”œâ”€â”€ ğŸ“„ .gitignore                    # Exclude .env, __pycache__, .pytest_cache
â”œâ”€â”€ ğŸ“„ README.md                     # Project documentation
â””â”€â”€ ğŸ“„ Dockerfile                    # Container image definition

```

---

## ğŸ“‹ Key Principles

### 1. **Strict Separation of Concerns**
Each layer has a single responsibility:
- **Domain:** Business logic (independent of framework/DB/HTTP)
- **Infrastructure:** Technical details (DB, caching, external APIs)
- **API:** HTTP request/response handling

### 2. **Dependency Rule (Clean Arch Core)**
Inner layers (Domain) must NEVER depend on outer layers (API, Infrastructure).

```python
# âœ… GOOD: Domain depends on nothing
class UserService:
    def __init__(self, repository):  # Injected, not imported from infrastructure
        self.repository = repository

# âŒ BAD: Domain depends on infrastructure
from infrastructure.repositories import UserRepository  # VIOLATION!
class UserService:
    def __init__(self):
        self.repository = UserRepository()
```

### 3. **Testability First**
- Domain services testable without mocks
- Repositories mockable for service tests
- Full integration tests with test database

### 4. **Async-Aware**
- `async def` for I/O-bound operations (DB, HTTP)
- `def` for pure logic and CPU-bound work
- Use `asyncio` utilities for concurrency

### 5. **Type Safety (Mandatory)**
- All functions: explicit type hints
- All models: Pydantic validation
- Type checker: `pyright --strict` (no errors allowed)

---

## ğŸš€ Generate Folders (Bash)

```bash
# Create directory structure
mkdir -p src/{core,api/v1/endpoints,domain/{models,schemas,services,exceptions},infrastructure/{repositories,external,cache},tests/{unit/{domain,infrastructure,api},integration,e2e},migrations/versions,scripts}

# Create __init__.py files
find src tests -type d -exec touch {}/__init__.py \;

# Create example files
touch src/main.py
touch src/core/{config,exceptions,logger,security}.py
touch src/domain/services/user_service.py
touch src/infrastructure/repositories/user_repository.py
touch tests/conftest.py

# Create root config files
touch pyproject.toml pyrightconfig.json .env.example .gitignore Dockerfile README.md
```

---

## âœ… Validation Checklist

Before committing code, verify:

- [ ] âœ… No mixed concerns (domain code NOT in api/, etc)
- [ ] âœ… All directories have `__init__.py`
- [ ] âœ… Tests mirror src structure
- [ ] âœ… Documentation exists (README, SETUP guides)
- [ ] âœ… `.env.example` has all required variables
- [ ] âœ… `.gitignore` excludes `.env`, `__pycache__`, `.pytest_cache`
- [ ] âœ… Type hints: `pyright --strict` runs clean
- [ ] âœ… Lint: `ruff check --fix` passes
- [ ] âœ… All tests green: `pytest tests/`
- [ ] âœ… No `print()` calls in src/ (use logging)

---

**Structure Version:** 1.0
**Framework:** FastAPI + SQLAlchemy 2.0
**Last Updated:** 30/01/2026
**Used By:** SoftArchitect AI (Dogfooding âœ¨)
